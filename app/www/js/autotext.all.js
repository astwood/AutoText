window.app={protocol:"https://",url:"app.autotext.co/api",loadingTimers:[],unsyncedTimer:null,listUpdateTimers:[],userExitCode:null,fullPhoneNumber:null,verificationType:null,country:null,phoneNumber:null,editing:false,viewing:false,reminding:false,copying:false,groupEditing:false,unsyncEdit:false,draftEdit:false,draftId:null,newDraft:false,newData:{name:"",recipient:"",content:"",time:"",reminder:"",repeat_options:""},canResetNewPage:false,editData:{},groupData:{name:"",contacts:[]},oldEditData:{},justSetEditOpts:false,stopDraftAddEdit:false,editViewStatus:"",editType:"",lastPageBeforeNew:"",lastPageBeforeSettings:"",lastPageBeforeTerms:"",lastPageBeforeMessageCredits:"",repeats:false,draftDeleteType:"single",dataId:null,dataScheduleId:null,dataSingle:null,stopCountryChange:true,ajaxAlertCallback:null,justSetSpam:false,justSetUnsynced:false,showingSpamFailNotification:false};app.services={};app.pages={};app.caches={contacts:[]};app.initialize=function(){var e=this;$.mobile.loader.prototype.options.text="Loading...";$.mobile.defaultPageTransition="slide";$.ajaxSetup({timeout:2e4});e.doBinds();for(pi in app.pages){var t=app.pages[pi];if(typeof t.init!="undefined"){t.init()}}var n=new app.services.CountryService;n.load();$("body").show()};app.alert=function(e,t,n){t=t==undefined?"Alert":t;navigator.notification.alert(e,function(){n&&n()},t,"OK")};app.pages.account={init:function(){$("#account").live("pagebeforeshow",function(){app.pages.account.onLoaded()});$(".purchase-link").live("click",function(){app.lastPageBeforePurchase=$.mobile.activePage.attr("id");$.mobile.changePage("#purchase")})},onLoaded:function(){var e=new app.services.AccountService;e.getCredits(function(e){$("#account-creds-balance").text(Math.floor(e.balance));$("#account-creds-allocated").text(Math.floor(e.allocated));$("#account-creds-remaining").text(Math.floor(e.remaining))})}};app.pages.addContactFromNumber={init:function(){$("#addcontactfromnumber .save").live("click",function(){var e=$("#addcontactfromnumber-number").val();if(e.substr(0,1)=="+"){e=app.userExitCode+e.substr(1)}e=e.replace(/[^0-9]/g,"");$("#addcontactfromnumber-number").val(e);var t={name:$("#addcontactfromnumber-name").val(),phone_number:e,part:"contact",custom:true};var n=new app.services.GroupService;n.validate($.param(t),"addcontactfromnumber",null,function(){t["phone_number_user"]=t["phone_number"];app.groupData["contacts"].push(t);app.pages.newGroup.update();$("#addcontactfromnumber-name, #addcontactfromnumber-number").val("");$.mobile.changePage("#newgroup",{reverse:false})},function(){app.ajaxAlert("addcontactfromnumber","Please ensure that you have entered your contact's name and phone number correctly then try again.")})});$("#addcontactfromnumber .back").live("click",function(){$("#addcontactfromnumber-name").val("");$("#addcontactfromnumber-number").val("")})}};app.pages.addNumber={init:function(){var e=this;$("#addNumber .back").live("click",function(){var t=$("#addNumber-number").val();if(t==""){$.mobile.changePage("#newMessageRecipients",{reverse:true});return}if(e.exist(t)){app.system.toastError("The number was already added.");return}e._validate(t,function(){$("#addNumber-number").val("");var e=app.pages.messageRecipients.numbers;e.push({name:"",number:t});app.pages.messageRecipients.onLoaded(e);$.mobile.changePage("#newMessageRecipients",{reverse:true})})})},_validate:function(e,t){var n={name:"temp name",phone_number:e,part:"contact",custom:true};var r=new app.services.GroupService;r.validate(n,"addNumber","Please ensure that you have entered your contact's name and phone number correctly then try again.",function(){t()})},exist:function(e){return app.system.getFirstOrDefault(app.pages.messageRecipients.numbers,function(t){return t.number==e})!=null}};app.pages.contactList={tobeAdded:[],fromGroup:true,_busy:false,initOnContactsLoaded:function(){var e=this;$("#txtFilterContacts").live("keyup",function(){e.filterContacts()});$("#contact-list>li").live("click",function(){if(e._busy){return}e._busy=true;var t=$(this);var n=$.trim(t.find(".contact-item-number").text());if(n.substr(0,1)=="+"){n=app.userExitCode+n.substr(1)}n=n.replace(/[^0-9]/g,"");var r={name:$.trim(t.find(".contact-item-name").text()),phone_number:n,part:"contact",custom:false,id:t.attr("data-id")};var i=new app.services.GroupService;i.validate(r,"addcontactfromcontact","Cannot add from Contacts - please try again",function(){r["phone_number_user"]=r["phone_number"];e.tobeAdded.push(r);t.addClass("contact-selected");app.system.toast(n+" was added.");e._busy=false},function(){e._busy=false})});$("#addcontactfromcontact a.back").live("click",function(){$("#txtFilterContacts").val("");if(e.fromGroup){for(var t=0;t<e.tobeAdded.length;t++){app.groupData["contacts"].push(e.tobeAdded[t])}app.pages.newGroup.update();$.mobile.changePage("#newgroup",{reverse:true})}else{var n=app.pages.messageRecipients.numbers;for(var r=0;r<e.tobeAdded.length;r++){var i=e.tobeAdded[r];n.push({name:i.name,number:i.phone_number})}app.pages.messageRecipients.onLoaded(n);$.mobile.changePage("#newMessageRecipients",{reverse:true})}})},renderContactList:function(){var e="";var t=app.caches.contacts;for(var n=0;n<t.length;n++){var r=t[n];e+='<li data-id="'+r.id+'" class="">                        <div class="contact-item-name">'+r.name+'</div>                        <div class="contact-item-number">'+r.number+"</div>                    </li>"}$("#contact-list").html(e)},onLoaded:function(e){this._busy=false;this.tobeAdded=[];this._updateSelected(e);this.filterContacts()},filterContacts:function(){var e=$("#txtFilterContacts").val().toLowerCase();if(e==""){$("#contact-list>li").removeClass("hidden")}else{$("#contact-list>li").each(function(){var t=$(this);if(t.text().toLowerCase().indexOf(e)>-1){t.removeClass("hidden")}else{t.addClass("hidden")}})}},_updateSelected:function(e){e=e==null?[]:e;$("#contact-list>li").each(function(){var t=$(this);var n=t.attr("data-id");var r=false;for(var i=0;i<e.length;i++){if(e[i]==n){r=true;break}}if(r){t.addClass("contact-selected")}else{t.removeClass("contact-selected")}})}};app.pages.forgotten={init:function(){$("#forgotten-submit-button").live("click",function(){app.pages.forgotten.forgottenSubmit()})},forgottenSubmit:function(){var e=$("#forgotten-country").val();var t=$("#forgotten-phone_number").val();if(t.substr(0,1)=="+"){t=app.userExitCode+t.substr(1)}t=t.replace(/[^0-9]/g,"");$("#forgotten-phone_number").val(t);var n=new app.services.AccountService;n.forgotten(e,t,function(){app.country=e;app.phoneNumber=t;app.verificationType="forgotten";$.mobile.changePage("#verification")},function(){app.ajaxAlert("forgotten","We couldn't find your phone number - please review.")})}};app.pages.global={init:function(){$('[data-role="page"]').live("pagebeforeshow",function(){app.pages.global.onLoaded()});$('[data-role="page"]').live("pageshow",function(){app.pages.global.onPageShow()});$('[data-role="page"]').live("pagebeforehide",function(){app.pages.global.onPageBeforeHide()})},onPageShow:function(){$('[data-role="page"] .ui-content').addClass("vHidden");$("#"+$.mobile.activePage.attr("id")+" .vHidden").removeClass("vHidden");$(" h1 .page-title").css({visibility:"visible"});$(".ui-header .ui-title").css({visibility:"visible"})},onPageBeforeHide:function(){$("h1 .page-title").css({visibility:"hidden"});$(".ui-header .ui-title").css({visibility:"hidden"})},onLoaded:function(){var e=this;$("body").attr("id",$.mobile.activePage.attr("id")+"-body");var t="Back";var n="";$("h1").css("overflow","hidden");switch($.mobile.activePage.attr("id")){case"schedule-options":t=app.editData["content"];if(typeof app.editData["name"]!="undefined"&&app.editData["name"].length>0)t=app.editData["name"]+" - "+t;if(app.reminding)t="RemindMe";n='<span class="page-title">Schedule SMS</span><span class="progressbar-status">Scheduling...</span><span class="progressbar"></span>';if(app.editing){$(".save").removeClass("cancel-state").find(".ui-btn-text").text("Save")}if(app.viewing){$("#new-name-link, #new-repeats-link, #new-date-link").addClass("link-disabled");$(".save").hide()}else{$("#new-name-link, #new-repeats-link, #new-date-link").removeClass("link-disabled");$(".save").show()}break;case"scheduled":n="Scheduled";break;case"history":n="History";break;case"groups":n="Groups";break;case"register":t="Login";n="Register";break;case"forgotten":t="Login";n="Reset Password";break;case"newgroup":t="Groups";n="Add Group";$(".save").show();if(app.groupEditing)n="Edit Group";break;case"message-name":t="Schedule SMS";n="Message Name";break;case"message-date":t="Schedule SMS";n="Message Date";break;case"message-repeats":t="Schedule SMS";n="Repeats";break;case"account":t="Settings";n="Settings";break;case"purchase":t="Settings";if(app.lastPageBeforePurchase=="status-dialog")t="Message Status";n="Purchase";break;case"help":t="Settings";n="Help";break;case"help-1":t="Help";n="Welcome";break;case"help-2":t="Welcome";n="Scheduled";break;case"help-3":t="Scheduled";n="History";break;case"help-4":t="History";n="New Message";break;case"help-5":t="New Message";n="Contact Groups";break;case"help-6":t="Contact Groups";n="RemindMe";break;case"help-7":t="RemindMe";n="Close";break;case"terms":t="Help";if(app.lastPageBeforeTerms=="verification"){t="Input Verification Code"}else if(app.lastPageBeforeTerms=="status-dialog"){t="Message Status"}n="Terms of Use";break;case"verification":t="Register";if(app.verificationType!="register")t="Reset Your Password";n="Verification";break;case"status-dialog":t=app.editData["content"];if(typeof app.editData["name"]!="undefined"&&app.editData["name"].length>0)t=app.editData["name"]+" - "+t;if(app.reminding)t="RemindMe";n="Message Status";break;case"settings":t="Scheduled";if(app.lastPageBeforeSettings=="history")t="History";n="Settings";break;case"new":t="Scheduled";if(app.lastPageBeforeNew=="history")t="History";if(app.lastPageBeforeNew=="groups")t="Groups";if(app.reminding){$("#addTo-from-contacts, #addTo-from-contacts-wrapper").hide()}else{$("#addTo-from-contacts, #addTo-from-contacts-wrapper").show()}app.canResetNewPage=true;var r=$("#new .edit-id").val().split("&");if(!app.editing&&!app.viewing){$("#new-status, #new-schedule").hide();$("#new .edit-id").val("");if(app.reminding){$("#new-status, #new-schedule").hide();$("#new-recipient").parents(".fieldcontain").hide();$("#new .ui-content").addClass("no-to");$("#new-content").removeClass("bigger-max-height biggest-no-to-max-height");$("#new-content").addClass("biggest-max-height")}}else if(!app.draftEdit&&(app.editing||app.viewing)&&$("#new-recipient").val().length<1){$.ajax({url:app.protocol+app.url+"/sms/view/"+r[0]+"/"+r[1]+"?u="+app.fullPhoneNumber+"&p="+app.password,type:"GET",beforeSend:function(){app.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){app.clearTimeouts();$.mobile.loading("hide")},success:function(t){t=JSON.parse(t);if(t.status=="OK"){e._updateSmsFields(t.data)}else{app.ajaxAlert("new")}},error:function(){app.ajaxAlert("new")}})}else if(app.draftEdit&&$("#new-recipient").val().length<1){var i=app.updateDrafts("list");r={};$(i).each(function(e){if(i[e].Sms["id"]==app.draftId){r=i[e];return false}return undefined});e._updateSmsFields(r)}if(!app.editing&&!app.viewing&&!app.copying&&!app.reminding){$("#new .ui-content").removeClass("no-to");$("#new-content").removeClass("biggest-max-height biggest-no-to-max-height bigger-max-height")}if(!app.reminding){$("#new-to-field").show()}else{$("#new-recipient").val(app.phoneNumber)}var s=$('#schedule-options [data-id="header-nav"] .save .ui-btn-text');if(s.length<1)s=$('#schedule-options [data-id="header-nav"] .save');if(app.viewing){s.text("Cancel");$("#new-submit-button").addClass("full-width");$("#new-submit-button .ui-btn-text").text("Re-schedule");$("#new-submit-button").css("width","97%");$("#new-recipient, #new-content, #new-date, #new-name").addClass("ui-disabled");$("#message-repeats-none").parents("fieldset").addClass("ui-disabled")}else{s.text("Save");$("#new-submit-button").removeClass("full-width");$("#new-submit-button .ui-btn-text").text("Schedule");$("#new-submit-button").css("width","auto");$("#new-recipient, #new-content, #new-date, #new-name").removeClass("ui-disabled");$("#message-repeats-none").parents("fieldset").removeClass("ui-disabled")}if(!app.reminding&&(app.editing||app.viewing)){$("#new-to-field").addClass("grey-bottom");$("#new-content").removeClass("bigger-max-height biggest-max-height biggest-no-to-max-height")}else if(!app.reminding){$("#new-to-field").removeClass("grey-bottom");$("#new-content").removeClass("biggest-max-height biggest-no-to-max-height");$("#new-content").addClass("bigger-max-height")}if(app.viewing&&!app.editing){$("#new-content-bubble").show();$("#new-content").hide();$("#new-submit-button").css("min-width","12em")}else{$("#new-content").show();$("#new-content-bubble").hide();$("#new-submit-button").css("min-width","0")}if(app.editing){$("#new-content").css("width","99.7%");$("#new-submit-button").hide()}else{$("#new-content").css("width","12.9em");$("#new-submit-button").show()}if(app.viewing){$("#message-repeats-wd").slider();$("#message-repeats-wd").slider("disable")}else{$("#message-repeats-wd").next().removeClass("ui-disabled")}if(app.reminding){$("#new-name").val("Remember To");$("h1").css("overflow","visible");$("#new-name").addClass("ui-disabled")}else{$("h1").css("overflow","hidden");$("#new-name").removeClass("ui-disabled")}if(app.editing){$(".save").show()}else{$(".save").removeClass("cancel-state").hide()}if(app.viewing){$("#new-submit-button").removeClass("ui-disabled")}else{$("#new-submit-button").addClass("ui-disabled")}if(app.viewing||app.editing){$("#new-status, #new-schedule").show()}if(!app.viewing){var o=false;$("#new-recipient, #new-content").each(function(){if($(this).val().length<1)o=true});if(!o){$("#new-submit-button").removeClass("ui-disabled")}else{$("#new-submit-button").addClass("ui-disabled")}}if(app.editing&&app.draftEdit){$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save")}if(app.copying){$("#new-date").val("");$("#new-date-text").text(moment().format("ddd, D MMM YYYY, hh:mm a"));$("#new-repeats-text").text("Never");$('#message-repeats input[name="message-repeats"]').removeAttr("checked");$("#message-repeats-none").attr("checked","checked");$("#message-repeats-wd option:selected").removeAttr("selected");$('#message-repeats-wd option[value="off"]').attr("selected","selected");$("#new-submit-button").css("min-width","0");$("#new-content-bubble").hide();try{$('#message-repeats input[name="message-repeats"]').checkboxradio("refresh")}catch(u){}try{$("#message-repeats-wd").slider("enable")}catch(u){}app.copying=false}app.stopDraftAddEdit=true;if(!app.editing&&!app.viewing&&!app.reminding){n="New Message"}else if(app.reminding){n='<span class="page-title"><img src="img/icon_reminder.png" /></span>'}else{var a=app.editData.content;if(app.editData.name!=undefined&&app.editData.name.length>0)a=app.editData.name+" - "+a;n=a}break;case"messagecredits":t="Help";if(app.lastPageBeforeMessageCredits=="status-dialog"){t="Message Status"}else if(app.lastPageBeforeMessageCredits=="purchase"){t="Purchase"}n="Message Credits";break;case"addcontactfromnumber":t="Back";n="Add a Number";break;case"addcontactfromcontact":t="Back";n="Add a Contact";break;case"addNumber":t="OK";n="Add a Number";break;case"newMessageRecipients":t="Back";n="Recipients";break}$(".back .ui-btn-text").text(t);$('[data-role="header"] .ui-title').html(n)},_updateSmsFields:function(e){app.stopDraftAddEdit=true;app.editData=e.Sms;$.extend(app.oldEditData,app.editData);app.editViewStatus=e.Schedule.status;if(app.editData.reminder==false){app.editData.reminder=0}else{app.editData.reminder=1}app.editData.time=app.editData.time_unix;app.editData.schedule_time=e.Schedule.send_time;if(e.Sms.reminder){app.reminding=true;$("#new-status, #new-schedule").hide();$("#new-recipient").parents(".fieldcontain").hide();$("#new .ui-content").addClass("no-to");$("#new-content").removeClass("biggest-max-height bigger-max-height");$("#new-content").addClass("biggest-no-to-max-height")}else{$("#new .ui-content").removeClass("no-to");$("#new-content").removeClass("biggest-max-height biggest-no-to-max-height bigger-max-height")}var t=e.Schedule.status_colour;var n=e.Schedule.status_text;var r="";if(!app.viewing){r="black";switch(e.Schedule.status_colour){case"92d050":r="green";break;case"f0b05f":r="amber";break;case"c80408":r="red";break}}else{t="b60c76";r="cross";switch(e.Schedule.status){case"delivered":case"pending":r="tick";break}}n+=' <img src="img/icon_'+r+'.png" class="status-icon" />';$("#new-recipient").val(e.Sms.recipient_user);$("#new-content").val(e.Sms.content);$("#new-content-bubble").html(e.Sms.content.replace(/\n/g,"<br />"));$("#new-status-text").html(n).attr("style","color: #"+t+" !important");$("#new-scheduled").text(moment(e.Schedule.send_time*1e3).format("ddd, D MMM YYYY, hh:mm a"));app.stopDraftAddEdit=true;$("#new-name").val(e.Sms.name);$("#new-name-text").text(e.Sms.name);$("#status-dialog-cost").text(e.Sms.cost);if(typeof e.Sms.cost!="undefined"){$("#status-dialog-cost-p").show()}else{$("#status-dialog-cost-p").hide()}if(!app.draftEdit&&!app.viewing){$("#delete-to-draft").show()}else{$("#delete-to-draft").hide()}var i=$("#new-date");if(app.viewing||i.hasClass("scrollified")){i.scroller("destroy").removeClass("scrollified")}if(!app.viewing){app.stopDraftAddEdit=true;var s=moment((new Date(e.Schedule.send_time*1e3)).toUTCString()).format("MM/DD/YYYY hh:mm A");i.val(s).scroller({preset:"calendar",theme:"ios",mode:"scroller",display:"inline",lang:"en"}).addClass("scrollified").trigger("change")}$("#new-date-text").text(moment((new Date(e.Schedule.send_time*1e3)).toUTCString()).format("ddd, D MMM YYYY, hh:mm a"));var o=false;var u="Never";if(e.Sms.repeat_options.length>0){var a=JSON.parse(e.Sms.repeat_options);if(typeof a=="object"){$('#message-repeats input[name="message-repeats"]').removeAttr("checked");if(a.D=="1"){o=true;u="Daily";app.stopDraftAddEdit=true;$("#message-repeats-d").attr("checked","checked")}else if(a.W=="1"){o=true;u="Weekly";app.stopDraftAddEdit=true;$("#message-repeats-w").attr("checked","checked")}else if(a.M=="1"){o=true;u="Monthly";app.stopDraftAddEdit=true;$("#message-repeats-m").attr("checked","checked")}else if(a.Y=="1"){o=true;u="Annually";app.stopDraftAddEdit=true;$("#message-repeats-y").attr("checked","checked")}else{app.stopDraftAddEdit=true;$("#message-repeats-none").attr("checked","checked")}if(o&&a.WD=="1"&&a.W!="1"){u+=", week days only"}app.stopDraftAddEdit=true;$("#message-repeats-wd option:selected").removeAttr("selected");$('#message-repeats-wd option[value="'+(a.WD=="1"?"on":"off")+'"]').attr("selected","selected")}}$("#new-repeats-text, #status-dialog-repeats-text").text(u);if(o&&e.Sms.time_unix!=e.Schedule.send_time){$("#status-dialog-repeats-startdate").text(moment((new Date(e.Sms.time_unix*1e3)).toUTCString()).format("DD/MM/YYYY hh:mm A"));if(typeof e.Sms.end_date!="undefined"&&e.Sms.end_date!="0"){$("#status-dialog-repeats-enddate").text(moment((new Date(e.Sms.end_date*1e3)).toUTCString()).format("DD/MM/YYYY hh:mm A"));$("#status-dialog-repeats-end").show()}else{$("#status-dialog-repeats-end").hide()}if(typeof e.Sms.time_unix!="undefined")$("#status-dialog-repeats-start").show()}else{$("#status-dialog-repeats-start").hide()}$('#message-repeats input[name="message-repeats"]').checkboxradio();$("#message-repeats-wd").slider();try{$('#message-repeats input[name="message-repeats"]').checkboxradio("refresh")}catch(f){}try{$("#message-repeats-wd").slider("refresh")}catch(f){}if(app.reminding){if(app.viewing||app.editing){$("#new-status, #new-schedule").show()}else{$("#new-status, #new-schedule").hide()}$("h1").css("overflow","visible");$("#new-name").addClass("ui-disabled")}else{$("h1").css("overflow","hidden");$("#new-name").removeClass("ui-disabled")}var l="";if(!app.editing&&!app.viewing&&!app.reminding){l="New Message"}else if(app.reminding){l='<span class="page-title"><img src="img/icon_reminder.png" /></span>'}else{var c=app.editData.content;if(app.editData.name!=undefined&&app.editData.name.length>0)c=app.editData.name+" - "+c;l=c}$('[data-role="header"] .ui-title').html(l);app.justSetEditOpts=true}};app.pages.groups={init:function(){$("#groups").live("pagebeforeshow",function(){app.pages.groups.onLoaded()});$("#groups .new").live("click",function(){$("#newgroup").removeClass("just-loaded");$.mobile.changePage("#newgroup")});$("#groups-list .view-group").live("click",function(e){e.preventDefault();if($(".aSwipeBtn").length>0){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()})}else{app.groupEditing=true;app.lastPageBeforeNew="groups";$("#newgroup .edit-id").val($(this).parents("li").attr("data-id"));$("#newgroup").removeClass("just-loaded");$.mobile.changePage("#newgroup")}});$("#groups-list .view-group .groups-schedule-link").live("click",function(){var e=$(this).parents("li").attr("data-id");var t=new app.services.GroupService;t.getGroup(e,function(e){var t=[];$.each(e["GroupContact"],function(n){var r=e["GroupContact"][n];t.push(r.phone_number_user)});app.editData={};app.newPageResetFields();app.lastPageBeforeNew="groups";app.newDraft=true;$("#new-recipient").val(t.join(","));$.mobile.changePage("#new")});return false})},onLoaded:function(){var e=this;app.groupEditing=false;var t=new app.services.GroupService;t.getAll(function(t){$("#groups-list li").not("#groups-group-template").remove();$.each(t,function(e){var n=t[e];var r=$("#groups-group-template").clone();r.find(".group-name").text(n.name);r.find(".group-contacts").text(n.members);r.attr("data-id",n.id);r.removeAttr("id");r.show();$("#groups-list").append(r)});$("#groups-list").listview("refresh");$("#groups-list li").swipeDelete({click:function(t){e._delete(t)}})});$('[data-role="footer"] li a').removeClass("ui-btn-active");$('[data-role="footer"] .groups-link').addClass("ui-btn-active")},_delete:function(e){e.preventDefault();var t=$(e.currentTarget).parents("li");var n=t.attr("data-id");var r=new app.services.GroupService;r.delete(n,function(){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()});t.slideUp(400,function(){app.pages[$.mobile.activePage.attr("id")].onLoaded()})})}};app.pages.history={init:function(){$("#history").live("pagebeforeshow",function(){app.pages.history.onLoaded()});$("#history").live("pageshow",function(){app.pages.history.onShow()});$("#history-message-list a.view-message").live("click",function(e){e.preventDefault();app.viewing=true;app.newPageResetFields();var t=$(this).parents("li").attr("data-id");var n=$(this).parents("li").attr("data-schedule-id");$("#new .edit-id").val(t+"&"+n);app.lastPageBeforeNew=$.mobile.activePage.attr("id");$.mobile.changePage("#new")})},onLoaded:function(){app.viewing=false;app.repeats=false;app.editing=false;app.reminding=false;app.draftEdit=false;app.unsyncEdit=false;app.lastPageBeforeNew=app.lastPageBeforeSettings="history";var e=new app.services.MessageService;e.getSent(function(e){$("#history-message-list li").not("#history-message-template").remove();if(e["schedules"].length>0){$.each(e["schedules"],function(t){var n=e["schedules"][t];var r=$("#history-message-template").clone();var i=new Date(n["Schedule"].send_time*1e3);var s=n["Sms"].content;if(n["Sms"].name.length>0)s=n["Sms"].name+" - "+s;r.attr("data-id",n["Sms"].id);r.attr("data-schedule-id",n["Schedule"].id);r.find(".message-recipients").text(n["Sms"].recipient_user);r.find(".message-content").text(s);r.find(".message-status").text(n["Schedule"].status_text);r.find(".message-date").text(app.formatDate(i));r.find(".message-time").text(app.formatTime(i));r.find(".ui-li-aside").addClass("colour-"+n["Schedule"].status_colour);switch(n["Schedule"].status){case"delivered":case"pending":r.find(".status-icon").attr("src","img/icon_tick.png");break;default:r.find(".status-icon").attr("src","img/icon_cross.png");break}r.removeAttr("id");r.show();$("#history-message-list").append(r);app.formatNumbersWithContactNames(n["Sms"].recipient_user,$('#history-message-list li[data-id="'+n["Sms"].id+'"] .message-recipients'))})}});$('[data-role="footer"] li a').removeClass("ui-btn-active");$('[data-role="footer"] .history-link').addClass("ui-btn-active")},onShow:function(){$.each(app.listUpdateTimers,function(e){clearTimeout(app.listUpdateTimers[e])});app.refreshList("history")}};app.pages.login={init:function(){$("#login").live("pagebeforeshow",function(){app.pages.login.onLoaded()});$("#login-submit-button").live("click",function(){var e=$("#login-country").val();var t=$("#login-phone_number").val();var n=$("#login-password").val();if(t.substr(0,1)=="+"){t=app.userExitCode+t.substr(1)}t=t.replace(/[^0-9]/g,"");$("#login-phone_number").val(t);var r=new app.services.AccountService;r.login(e,t,n,function(r){app.fullPhoneNumber=r.data["phone_number"];app.userExitCode=r.data["exit_code"];app.phoneNumber=t;app.country=e;app.password=n;$.cookie("logins",JSON.stringify({country:app.country,phone_number:app.phoneNumber,password:app.password}),{expires:7300});$.mobile.changePage("#scheduled");$(".ui-page, .ui-mobile-viewport").addClass("ui-page-bg-light")},function(){app.ajaxAlert("login","Your login details are wrong - please review.")})})},onLoaded:function(){app.stopCountryChange=false;$("#login-phone_number").val("");$("#login-password").val("")}};app.pages.messageCredits={init:function(){$("#messagecredits").live("pagebeforeshow",function(){app.pages.messageCredits.onLoaded()})},onLoaded:function(){$("#messagecredits .ui-input-search .ui-input-text").val("");var e=new app.services.CreditService;e.getInternationalCredits(function(e){$("#messagecredits-list li").remove();$.each(e,function(t){var n=e[t];var r=$("<li></li>");r.html('<div class="country-name floatL">'+n.name+'</div><div class="account-creds ui-li-desc">'+n.credits+"</div>");$("#messagecredits-list").append(r);if(t==app.country){$("#messagecredits-country_name").text(n.name);$("#messagecredits-credits").text(n.credits)}});$("#messagecredits-list").listview("refresh")})}};app.pages.messageDate={init:function(){$("#new-date").live("change",function(){if($("#new-date-text").text().length>0)$("#new-date-text, #new-scheduled").text(moment($(this).val()).format("ddd, D MMM YYYY, hh:mm a"));$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save");if(!app.stopDraftAddEdit&&app.draftId==null){app.draftId=app.generateUUID()}if(!app.stopDraftAddEdit){app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId)}});$("#message-date .back").live("click",function(){$.mobile.changePage("#schedule-options",{reverse:true})})}};app.pages.messageName={init:function(){$("#message-name .back").live("click",function(e){e.preventDefault();if(!app.viewing){var t={name:$("#new-name").val(),part:"name"};$.extend(app.newData,t);$.extend(app.editData,t);if(!app.unsyncEdit){var n=new app.services.MessageService;n.validate("message-name",$.param(t),function(){$.mobile.changePage("#schedule-options",{reverse:true})},function(){app.ajaxAlert("message-name","Please ensure that you have entered a valid message name then try again.")},function(){app.saveAsUnsynced();$.mobile.changePage("#schedule-options",{reverse:true})})}else{$.mobile.changePage("#schedule-options",{reverse:true})}}else{$.mobile.changePage("#schedule-options",{reverse:true})}});$("#new-name").live("keyup",function(){$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save");if(!app.stopDraftAddEdit&&app.draftId==null){app.draftId=app.generateUUID()}app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId)})}};app.pages.messageRecipients={_initialized:false,numbers:[],init:function(){var e=this;if(this._initialized){return}this._initialized=true;$("#newMessageRecipients .back").live("click",function(){e.onBack()});$("#btn-add-contact-to-recipients").live("click",function(){app.pages.contactList.fromGroup=false;app.pages.contactList.onLoaded(e.getNumericNumbers());$.mobile.changePage("#addcontactfromcontact")});$("#btn-add-custom-to-recipients").live("click",function(){$.mobile.changePage("#addNumber")});$("#selectedNumbers li").live("click",function(){var e=$(this);if($(".aSwipeBtn").css("overflow")=="visible"&&$(".aSwipeBtn").length>0){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){e.find(".ui-li-heading").css("max-width","50%");$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()})}})},onLoaded:function(e){var t=this;t.numbers=[];for(var n=0;n<e.length;n++){var r=e[n];if(r!=null&&r!=""){t.numbers.push(r)}}if(t.numbers.length>0&&typeof t.numbers[0]!="object"){t.fixNumberNames()}$("#totalNumbers").html(t.numbers.length);$("#selectedNumbers li").not("#list-template").remove();$.each(t.numbers,function(e,t){var n=$("#list-template").clone();var r=t.name==undefined||t.name==""?"":t.name;n.find(".contact-name").html(r);n.find(".contact-number").html(t.number);n.removeAttr("id");n.show();$("#selectedNumbers").append(n)});try{$("#selectedNumbers").listview("refresh")}catch(i){}$("#selectedNumbers li").swipeDelete({click:function(){t.onDelete(this)}})},onDelete:function(e){var t=this;var n=$(e).closest("li");n.slideUp(400,function(){var e=n.prevAll().length-1;t.numbers.splice(e,1);n.remove();$("#totalNumbers").html(t.numbers.length)})},onBack:function(){var e=this;$("#new-recipient").val(e.getNumericNumbers());if(app.newDraft==false||app.draftId==null||e.numbers.length>0){app.stopDraftAddEdit=false;e.saveNewToDraft()}$.mobile.changePage("#new",{reverse:true})},getNumericNumbers:function(){var e=[];for(var t=0;t<this.numbers.length;t++){e.push(this.numbers[t].number)}return e},fixNumberNames:function(){var e=[];for(var t=0;t<this.numbers.length;t++){var n=this.numbers[t];var r=app.system.getFirstOrDefault(app.caches.contacts,function(e){return e.number==n});e.push({name:r==null?"":r.name,number:n})}this.numbers=e},saveNewToDraft:function(){var e=false;$("#new-recipient, #new-content").each(function(){if($.trim($(this).val()).length<1)e=true});if(!e){$("#new-submit-button").removeClass("ui-disabled")}else{$("#new-submit-button").addClass("ui-disabled")}if(app.editing&&$("#new .save").text()!="Save"&&!app.stopDraftAddEdit){$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save")}if(!app.stopDraftAddEdit&&(app.draftId==null||app.newDraft)){app.draftId=app.generateUUID();app.newDraft=false}if(!app.stopDraftAddEdit){app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId)}else{app.stopDraftAddEdit=false}}};app.pages.messageRepeats={_loadedRepeatOptions:"",init:function(){var e=this;$("#message-repeats").live("pagebeforeshow",function(){app.pages.messageRepeats.onLoaded()});$("#message-repeats-w").live("change",function(){if(!app.stopDraftAddEdit&&app.draftId==null){app.draftId=app.generateUUID()}app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId);$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save");$("#message-repeats-wd option").removeAttr("selected");$('#message-repeats-wd option[value="off"]').attr("selected","selected");$("#message-repeats-wd").slider("refresh").slider("disable")});$("#message-repeats-none, #message-repeats-d, #message-repeats-m, #message-repeats-y").live("change",function(){if(!app.stopDraftAddEdit&&app.draftId==null){app.draftId=app.generateUUID()}app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId);$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save");$("#message-repeats-wd").slider("enable")});$("#message-repeats-wd").live("change",function(){if(!app.stopDraftAddEdit&&app.draftId==null){app.draftId=app.generateUUID()}app.updateDrafts("view",app.draftId);app.updateDrafts("edit",app.draftId);$("#new .save, #schedule-options .save").removeClass("cancel-state").find(".ui-btn-text").text("Save")});$("#message-repeats .back").live("click",function(t){e._onBack(t)})},onLoaded:function(){if($('#message-repeats input[name="message-repeats"]:checked').length<1){$("#message-repeats-none").attr("checked","checked");$('#message-repeats input[name="message-repeats"]').checkboxradio("refresh")}this._loadedRepeatOptions=app.editData.repeat_options;var e=JSON.parse(app.editData["repeat_options"]);if(e.W!=undefined&&e.W=="1"){$("#message-repeats-wd").slider("disable")}else{$("#message-repeats-wd").slider("enable")}},_onBack:function(e){if(!app.viewing){e.preventDefault();var t=$('input[name="message-repeats"]:checked').val().toUpperCase();var n=$("#message-repeats-wd option:selected").val()=="on";var r={D:0,W:0,M:0,Y:0,WD:0};if(typeof r[t]!="undefined")r[t]=1;if(n)r["WD"]=1;var i={repeat_options:JSON.stringify(r),part:"repeat_options"};if(i.repeat_options!=this._loadedRepeatOptions){app.newData.repeatOptionsHasChanged=true;app.editData.repeatOptionsHasChanged=true}$.extend(app.newData,i);$.extend(app.editData,i);if(!app.unsyncEdit){var s=new app.services.MessageService;s.validate("message-repeats",$.param(i),function(){$.mobile.changePage("#schedule-options",{reverse:true})},function(){app.ajaxAlert("message-repeats","Please ensure that you have entered valid repeat options then try again.")},function(){app.saveAsUnsynced();$.mobile.changePage("#schedule-options",{reverse:true})})}else{$.mobile.changePage("#schedule-options",{reverse:true})}}else{$.mobile.changePage("#schedule-options",{reverse:true})}}};app.pages.newGroup={init:function(){var e=this;$("#newgroup").live("pagebeforeshow",function(){app.pages.newGroup.onLoaded()});$("#add-from-contact").live("click",function(){app.groupData["name"]=$("#newgroup-name").val();e._addFromContact();$.mobile.changePage("#addcontactfromcontact")});$("#add-from-number").live("click",function(){app.groupData["name"]=$("#newgroup-name").val();$.mobile.changePage("#addcontactfromnumber")});$("#newgroup-contacts-list li").live("click",function(){var e=$(this);if($(".aSwipeBtn").css("overflow")=="visible"&&$(".aSwipeBtn").length>0){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){e.find(".ui-li-heading").css("max-width","50%");$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()})}});$("#newgroup .save").live("click",function(){app.groupData["name"]=$("#newgroup-name").val();var e=new app.services.GroupService;e.addEdit(app.groupEditing,$.param(app.groupData),function(){$.mobile.changePage("#groups",{reverse:false})},function(){app.ajaxAlert("newgroup","Please ensure that you have entered your group's name correctly then try again.")})})},onLoaded:function(){var e=this;if(!$("#newgroup").hasClass("just-loaded")){if(!app.groupEditing){$("#newgroup-name, #addcontactfromnumber-name, #addcontactfromnumber-number").val("");app.groupData={name:"",contacts:[]};e.update()}else{var t=$("#newgroup .edit-id").val();var n=new app.services.GroupService;n.getGroup(t,function(t){app.groupData={name:t.Group.name,contacts:t.GroupContact};e.update()})}$("#newgroup").addClass("just-loaded")}},update:function(){var e=this;$("#newgroup-name").val(app.groupData.name);$("#newgroup-total").text(app.groupData.contacts.length);$("#newgroup-contacts-list li").not("#newgroup-contact-template").remove();$.each(app.groupData.contacts,function(e){var t=app.groupData.contacts[e];var n=$("#newgroup-contact-template").clone();n.find(".contact-name").text(t.name);n.find(".contact-number").text(t.phone_number_user);n.removeAttr("id");n.show();$("#newgroup-contacts-list").append(n)});$("#newgroup-contacts-list").listview("refresh");$("#newgroup-contacts-list li").swipeDelete({click:function(t){e.deleteContact(t)}})},deleteContact:function(e){e.preventDefault();var t=$(e.currentTarget).parents("li");var n=t.prevAll().length-1;t.slideUp(400,function(){t.remove();app.groupData.contacts.splice(n,1);$("#newgroup-total").text(app.groupData.contacts.length);if(app.groupEditing){var e=$("#newgroup .edit-id").val();var r=new app.services.GroupService;r.editGroup(e)}})},_addFromContact:function(){var e=[];var t=app.groupData["contacts"];if(t!=undefined){for(var n=0;n<t.length;n++){var r=t[n];if(r.custom==false){e.push(r.id)}}}app.pages.contactList.fromGroup=true;app.pages.contactList.onLoaded(e)}};app.pages.newMessage={init:function(){var e=this;$("#new").live("pageshow",function(){app.stopDraftAddEdit=false;$(this).addClass("ui-page-active")});$("#new-content").live("keyup",function(){app.pages.messageRecipients.saveNewToDraft()});$("#new .save").live("click",function(){var t={recipient:$("#new-recipient").val(),content:$("#new-content").val(),reminder:app.reminding?"1":"0",part:"recipient_content"};$.extend(app.newData,t);$.extend(app.editData,t);e.saveNew()});$("#addTo-from-contacts").live("click",function(){if(app.viewing){$("#btn-add-contact-to-recipients, #btn-add-custom-to-recipients").addClass("ui-disabled")}else{$("#btn-add-contact-to-recipients, #btn-add-custom-to-recipients").removeClass("ui-disabled");}});$("#new-submit-button").live("click",function(){e._submit()});$("#new #addTo-from-contacts").live("click",function(){if(!$(this).hasClass("link-disabled")){app.pages.messageRecipients.onLoaded($("#new #new-recipient").val().split(","));$.mobile.changePage("#newMessageRecipients")}});$("#edit-schedule-options-link").live("click",function(){var e={recipient:$("#new-recipient").val(),content:$("#new-content").val(),reminder:app.reminding?"1":"0"};$.extend(app.newData,e);$.extend(app.editData,e);$.mobile.changePage("#schedule-options")})},_submit:function(){if(!app.viewing){var e=$("#new-recipient").val();if(e.length>0){var t=[];var n=e.split(",");$.each(n,function(e){var r=n[e];if(r.substr(0,1)=="+"){r=app.userExitCode+r.substr(1)}t.push(r.replace(/[^0-9]/g,""))});e=t.join(",");$("#new-recipient").val(e)}var r={recipient:e,content:$("#new-content").val(),reminder:app.reminding?"1":"0",part:"recipient_content"};$.extend(app.newData,r);$.extend(app.editData,r);if(!app.unsyncEdit){var i=new app.services.MessageService;i.validate("new",$.param(r),function(){$.mobile.changePage("#schedule-options")},function(){var e="Please ensure that you have entered your recipient(s) and message correctly then try again.";if(app.reminding){e="Please ensure that you have entered your message correctly then try again."}app.ajaxAlert("new",e)},function(){app.saveAsUnsynced();$.mobile.changePage("#schedule-options")})}else{$.mobile.changePage("#schedule-options")}}else{app.viewing=false;app.copying=true;$.mobile.changePage("#new",{allowSamePageTransition:true});$("#new-submit-button").removeClass("ui-disabled")}},saveNew:function(){app.editType="single";app.pages.newMessage.newActualSave()},newActualSave:function(){app.loadingTimers.push(setTimeout(function(){app.doProgressBar()},1e3));var e=$("#new .edit-id").val().split("&");if(app.editType=="single"){app.editData.oldSchedule=e[1];if(app.editData.repeatOptionsHasChanged!=true){app.editData.repeat_options=JSON.stringify({D:0,W:0,M:0,Y:0,WD:0})}delete app.editData.id}if(app.draftEdit){delete app.editData["id"];delete app.editData["is_draft"];delete app.editData["recipient_user"];delete app.editData["part"]}if(app.editing&&app.editData["time"]==undefined){app.editData["time"]=(new Date($("#new-date").val())).getTime()/1e3}if(app.draftEdit){var t=app.updateDrafts("view",app.draftId);var n=t.Sms["real_id"];if(n!=undefined&&n.length>0){e=n.split("&")}}var r=app.editing?app.editData:app.newData;if(r.recipient.length>0){var i=[];var s=r.recipient.split(",");$.each(s,function(e){var t=s[e];if(t.substr(0,1)=="+"){t=app.userExitCode+t.substr(1)}i.push(t.replace(/[^0-9]/g,""))});r.recipient=i.join(",");$("#new-recipient").val(r.recipient)}if(!app.unsyncEdit){if(app.editing&&app.editData.schedule_time!=undefined){app.editData.time=app.editData.schedule_time}var o=new app.services.MessageService;o.editOrSchedule(e[0],$.param(app.editing?app.editData:app.newData),function(e){app.justSetSpam=e.data=="1";if(app.draftEdit&&app.draftId.length>0){app.updateDrafts("delete",app.draftId)}$("#new h1").css("overflow","hidden");$.mobile.changePage("#scheduled")},function(){app.clearTimeouts();try{$("#"+$.mobile.activePage.attr("id")+" .progressbar").progressbar({value:parseInt($("#"+$.mobile.activePage.attr("id")+" .progressbar").attr("max-value"))})}catch(e){console.log("new message progressbar error: "+e)}$("#new h1 .progressbar-status, #new h1 .progressbar, #schedule-options h1 .progressbar-status, #schedule-options h1 .progressbar").remove();$("#new h1 .page-title, #schedule-options h1 .page-title").show();$("#new h1, #schedule-options h1").append('<span class="progressbar-status">Scheduling...</span><span class="progressbar"></span>');try{TolitoProgressBar("#new h1 .progressbar, #schedule-options h1 .progressbar").isMini(true).showCounter(false).setInterval(20).setMax(125).setOuterTheme("b").setInnerTheme("c").build().init()}catch(t){console.log("progress bar 1782 error: "+t)}$.mobile.loading("hide")})}else{$.mobile.changePage("#scheduled")}}};app.pages.purchase={init:function(){var e=this;$("#purchase").live("pagebeforeshow",function(){app.pages.purchase.onLoaded()});$(".product-btn").live("click",function(){var e=$(this).attr("id").replace("product-btn-","");var t=$(this).attr("data-value")*1;logger.log(e+":"+t);try{purchaseManager.requestProductData(e,function(e){purchaseManager.makePurchase(e.id,1)},function(e){app.alert("purchase callback error: "+e,"Error")})}catch(n){app.alert("purchase error: "+n,"Error")}});$(document).bind("purchaseManagerLoaded",function(){e._initPurchaseManager()})},onLoaded:function(){var e=new app.services.BillingService;e.getProducts(function(e){$("#purchase-product-list").html("");$.each(e,function(t){var n=e[t];var r=$('<a href="#" class="product-btn" data-role="button" id="product-btn-'+t+'" data-value="'+n+'">'+n+' Credit Bundle <span class="price-value"></span></a>');$("#purchase-product-list").append(r)});$("#purchase-product-list .product-btn").button()})},_initPurchaseManager:function(){try{window.purchaseManager=window.plugins.inAppPurchaseManager;window.plugins.inAppPurchaseManager.onPurchased=function(e,t,n){logger.log("purchased: "+t);var r=new app.services.BillingService;r.verify(e,t,n,function(){app.alert("Thanks. Your purchase has been completed and balance updated.","Done",function(){$.mobile.changePage("#account")})})};window.plugins.inAppPurchaseManager.onFailed=function(e,t){logger.log("error: "+t);app.ajaxAlert("purchase","The purchase was unsuccessful. Please try again.")}}catch(e){console.log("init plugin err: "+e)}}};app.pages.register={init:function(){$("#register-submit-button").live("click",function(){var e=$("#register-country").val();var t=$("#register-phone_number").val();var n=$("#register-password").val();if(t.substr(0,1)=="+"){t=t.replace(/[^0-9]/g,"");t=app.userExitCode+t}else{t=t.replace(/[^0-9]/g,"")}$("#register-phone_number").val(t);var r=new app.services.AccountService;r.register(e,t,n,function(r){app.country=e;app.phoneNumber=t;app.password=n;app.verificationType="register";app.fullPhoneNumber=r.data["phone_number"];app.userExitCode=r.data["exit_code"];$.cookie("logins",JSON.stringify({country:app.country,phone_number:app.phoneNumber,password:app.password}));$.mobile.changePage("#verification")},function(){app.ajaxAlert("register",'Your registration details are incorrect. If you are having difficulty registering take a look at the <a href="http://autotext.co/support" rel="external" target="_blank">FAQ</a>.')})})}};app.pages.scheduled={init:function(){$("#scheduled").live("pagebeforeshow",function(){app.pages.scheduled.onLoaded()});$("#scheduled").live("pageshow",function(){app.pages.scheduled.onShow()});$(".edit-message").live("click",function(){$("#new-content").height(250)});$(".settings").live("click",function(){$.mobile.changePage("#settings")});$("#delete-repeats-confirm .cancel").live("click",function(){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()});$("#scheduled .dialog-overlay, #delete-repeats-confirm").hide()});$("#delete-repeats-confirm .all").live("click",function(){$.fn.swipeDeleteType="all";$.fn.swipeDoDelete.call(app);$("#scheduled .dialog-overlay, #delete-repeats-confirm").hide()});$("#delete-repeats-confirm .single").live("click",function(){$.fn.swipeDeleteType="single";$.fn.swipeDoDelete.call(app);$("#scheduled .dialog-overlay, #delete-repeats-confirm").hide()});$("#scheduled-message-list a.edit-message").live("click",function(e){e.preventDefault();if($(".aSwipeBtn").length>0){$("div.aSwipeBtn, ."+$.fn.swipeOptions.btnClass).animate({width:"toggle"},200,function(){$(this).parents("li").find(".ui-li-aside, .ui-icon-arrow-r").show();$(this).parents(".delete-btn-container").remove()})}else{app.dataSingle=false;app.repeats=typeof $(this).parents("li").attr("data-repeats")!="undefined";app.editing=true;app.draftEdit=typeof $(this).parents("li").attr("data-draft")=="string";app.unsyncEdit=typeof $(this).parents("li").attr("data-unsynced")=="string";app.newPageResetFields();app.newDraft=false;var t=app.dataId=$(this).parents("li").attr("data-id");var n=app.dataScheduleId=$(this).parents("li").attr("data-schedule-id");if(app.draftEdit){app.draftId=$(this).parents("li").attr("data-draft")}else{app.draftId=app.generateUUID()}$("#new .edit-id").val(t+"&"+n);app.lastPageBeforeNew=$.mobile.activePage.attr("id");$.mobile.changePage("#new")}})},onLoaded:function(){var e=this;app.repeats=false;app.editing=false;app.reminding=false;app.draftEdit=false;app.unsyncEdit=false;app.lastPageBeforeNew=app.lastPageBeforeSettings="scheduled";var t=new app.services.MessageService;t.getScheduled(function(t){e._render(t)});$('[data-role="footer"] li a').removeClass("ui-btn-active");$('[data-role="footer"] .schedule-link').addClass("ui-btn-active")},onShow:function(){$.each(app.listUpdateTimers,function(e){clearTimeout(app.listUpdateTimers[e])});app.refreshList("scheduled");app.processUnsynced()},_render:function(e){var t=this;$("#scheduled-message-list li").not("#scheduled-message-template").remove();var n=app.updateDrafts("list");if(n!=null&&typeof n=="object"&&n.length>0){e["schedules"]=n.concat(e["schedules"])}var r=false;if(e["schedules"].length>0){$.each(e["schedules"],function(t){var n=e["schedules"][t];var i=$("#scheduled-message-template").clone();var s=new Date(n["Schedule"].send_time*1e3);var o=JSON.parse(n.Sms.repeat_options);var u=n["Sms"].content;var a=typeof n["Sms"].is_draft!="undefined";var f=a&&n["Schedule"].status=="unsynced";if(n["Sms"].name.length>0)u=n["Sms"].name+" - "+u;if(!a&&(o.D==1||o.W==1||o.M==1||o.Y==1)){i.attr("data-repeats","repeats")}if(n["Schedule"].status=="no_credit"){i.addClass("no_credit")}if(a){i.attr("data-draft",n["Sms"].id)}if(f){i.attr("data-unsynced",n["Sms"].id)}var l=n["Sms"].id;if(n["Sms"].real_id!=undefined&&n["Sms"].real_id.length>0){l=n["Sms"].real_id.split("&")[0]}i.attr("data-id",l);i.attr("data-schedule-id",n["Schedule"].id);i.find(".message-recipients").text(n["Sms"].recipient_user);i.find(".message-content").text(u);i.find(".message-status").text(n["Schedule"].status_text);if(!a){i.find(".message-date").text(app.formatDate(s));i.find(".message-time").text(app.formatTime(s))}else{i.find(".message-date, .message-time").text("-")}if(n["Schedule"].status=="no_credit")r=true;i.find(".ui-li-aside").addClass("colour-"+n["Schedule"].status_colour);switch(n["Schedule"].status_colour){default:case"":case"a3a3a3":i.find(".status-icon").attr("src","img/icon_black.png");break;case"92d050":i.find(".status-icon").attr("src","img/icon_green.png");break;case"f0b05f":i.find(".status-icon").attr("src","img/icon_amber.png");break;case"c80408":i.find(".status-icon").attr("src","img/icon_red.png");break}i.removeAttr("id");i.show();$("#scheduled-message-list").append(i);app.formatNumbersWithContactNames(n["Sms"].recipient_user,$('#scheduled-message-list li[data-id="'+n["Sms"].id+'"] .message-recipients'))})}$('#scheduled-message-list li:not(".no_credit")').swipeDelete({click:function(e){t._delete(e)}});if(app.justSetSpam){app.justSetSpam=false;app.ajaxAlert("scheduled","Unfortunately this message has been flagged by our system for potential SPAM content and will be reviewed by our team before it is allowed to send.")}else if(app.justSetUnsynced){app.justSetUnsynced=false;app.ajaxAlert("scheduled","We can't sync this message with our system. Please connect to a mobile network or internet connection.")}else if(e["show_spam_fail_notification"]==true){app.showingSpamFailNotification=true;app.ajaxAlert("scheduled","Unfortunately one or more messages have been reviewed and found to have SPAM content within them. This message will be moved to your history folder.")}else if(r){var i=$.cookie("noCreditShown");if(i==undefined){$.cookie("noCreditShown",JSON.stringify(true),{expires:1});app.ajaxAlert("scheduled","You don't have enough credits to send one or more messages.")}}},_delete:function(e){e.preventDefault();var t=$(e.currentTarget);var n=typeof t.parents("li").attr("data-repeats")!="undefined";if(n){$("#scheduled .dialog-overlay, #delete-repeats-confirm").show()}else{$.fn.swipeDoDelete.call(t)}}};app.pages.scheduleOptions={init:function(){var e=this;$("#schedule-options").live("pagebeforeshow",function(){app.pages.scheduleOptions.onLoaded()});$("#delete-to-draft-repeats-confirm .cancel").live("click",function(){$("#schedule-options .dialog-overlay, #delete-to-draft-repeats-confirm").hide()});$("#delete-to-draft-repeats-confirm .all").live("click",function(){app.draftDeleteType="all";e._doDraftDelete();$("#schedule-options .dialog-overlay, #delete-to-draft-repeats-confirm").hide()});$("#delete-to-draft-repeats-confirm .single").live("click",function(){app.draftDeleteType="single";e._doDraftDelete();$("#schedule-options .dialog-overlay, #delete-to-draft-repeats-confirm").hide()});$("#schedule-options .save").live("click",function(){if(!app.viewing){if($(this).hasClass("cancel-state")){$.mobile.changePage("#new",{reverse:true})}else{var e=$("#new-date").val().length>0?(new Date($("#new-date").val())).getTime():(new Date).getTime();e=e/1e3;var t={time:e};app.editData.schedule_time=e;$.extend(app.newData,t);$.extend(app.editData,t);delete app.newData["part"];delete app.editData["part"];app.pages.newMessage.saveNew()}}else{$.mobile.changePage("#history")}});$("#schedule-options .back").live("click",function(){var e=$("#new-date").val().length>0?(new Date($("#new-date").val())).getTime():(new Date).getTime();e=e/1e3;var t={time:e};$.extend(app.newData,t);$.extend(app.editData,t);$.mobile.changePage("#new",{reverse:true})});$("#new-name-link").live("click",function(){if(!$(this).hasClass("link-disabled")){$.mobile.changePage("#message-name")}});$("#new-date-link").live("click",function(){if(!$(this).hasClass("link-disabled")){$.mobile.changePage("#message-date")}});$("#new-repeats-link").live("click",function(){if(!$(this).hasClass("link-disabled")){$.mobile.changePage("#message-repeats")}});$("#delete-to-draft-btn").live("click",function(){app.draftDeleteType="all";e._doDraftDelete()})},onLoaded:function(){var e=$("#new-date");if(!app.viewing&&!e.hasClass("scrollified")){e.scroller({preset:"calendar",theme:"ios",mode:"scroller",display:"inline",lang:"en"}).addClass("scrollified")}app.pages.scheduleOptions._newSmsSetData();var t="Never";if(app.newData.repeat_options.length>0){var n=JSON.parse(app.newData.repeat_options);if(typeof n=="object"&&n!=null){var r=false;if(n.D=="1"){r=true;t="Daily"}else if(n.W=="1"){r=true;t="Weekly"}else if(n.M=="1"){r=true;t="Monthly"}else if(n.Y=="1"){r=true;t="Annually"}if(r&&n.WD=="1"&&n.W!="1"){t+=", week days only"}}}if(!app.justSetEditOpts){$("#new-name-text").text(app.newData.name);if($("#new-date-text").text().length<1)$("#new-date-text").text(moment().format("ddd, D MMM YYYY, hh:mm a"));$("#new-repeats-text").text(t)}else{app.justSetEditOpts=false}if(app.viewing){$("#schedule-options .bar-link .floatR").css("margin-right","15px");$("#schedule-options .bar-link .arrow").hide()}else{$("#schedule-options .bar-link .floatR").css("margin-right","30px");$("#schedule-options .bar-link .arrow").show()}},_newSmsSetData:function(){var e={name:$("#new-name").val(),part:"name"};$.extend(app.newData,e);$.extend(app.editData,e);var t=$('input[name="message-repeats"]:checked');if(t.length<1)t=$("#message-repeats-none");var n=t.val().toUpperCase();var r=$("#message-repeats-wd option:selected").val()=="on";var i={D:0,W:0,M:0,Y:0,WD:0};if(typeof i[n]!="undefined")i[n]=1;if(r)i["WD"]=1;e={repeat_options:JSON.stringify(i),part:"repeat_options"};$.extend(app.newData,e);$.extend(app.editData,e)},_doDraftDelete:function(){$.ajax({url:app.protocol+app.url+"/sms/delete/"+app.dataId+(app.dataSingle?"/"+app.dataScheduleId:"")+"?u="+app.fullPhoneNumber+"&p="+app.password,type:"GET",beforeSend:function(){app.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){app.draftDeleteType="all";app.clearTimeouts();$.mobile.loading("hide")},success:function(e){e=JSON.parse(e);if(e.status=="OK"){app.updateDrafts("view",app.generateUUID(),null,null,true);$.mobile.changePage("#scheduled",{transition:"slideup",reverse:true})}else{app.ajaxAlert("schedule-options")}},error:function(){app.ajaxAlert("schedule-options")}})}};app.pages.settings={init:function(){$("#settings").live("pagebeforeshow",function(){app.pages.settings.onLoaded()});$("#settings-account-link").live("click",function(){$.mobile.changePage("#account")});$("#settings-help-link").live("click",function(){$.mobile.changePage("#help")});$("#settings .reset-password-link").live("click",function(){$("#settings .dialog-overlay, #reset-password-confirm").show()});$("#reset-password-confirm .ok").live("click",function(){$.removeCookie("logins");$("#forgotten-country option").removeAttr("selected");$('#forgotten-country option[value="'+app.country+'"]').attr("selected","selected");$("#forgotten-phone_number").val(app.phoneNumber);$("#settings .dialog-overlay, #reset-password-confirm").hide();app.pages.forgotten.forgottenSubmit()});$("#reset-password-confirm .cancel").live("click",function(){$("#settings .dialog-overlay, #reset-password-confirm").hide()});$("#settings .logout-link").live("click",function(){$("#settings .dialog-overlay, #logout-confirm").show()});$("#logout-confirm .ok").live("click",function(){$.removeCookie("logins");$.removeCookie("noCreditShown");$("#login-country option:selected").removeAttr("selected");$("#login-country option:first").attr("selected","selected");try{$("#login-country").selectmenu().selectmenu("refresh")}catch(e){}$("#login-phone_number, #login-password").val("");$("#settings .dialog-overlay, #logout-confirm").hide();$(".ui-page, .ui-mobile-viewport").removeClass("ui-page-bg-light");$.mobile.changePage("#login")});$("#logout-confirm .cancel").live("click",function(){$("#settings .dialog-overlay, #logout-confirm").hide()})},onLoaded:function(){$("#settings-full-number").text("+"+app.fullPhoneNumber)}};app.pages.splash={init:function(){$("#splash").live("pageshow",function(){app.pages.splash.onShow()})},onShow:function(){app.clearTimeouts();var e=$.cookie("logins");var t=$.cookie("drafts");if(typeof t=="undefined"){$.cookie("drafts",JSON.stringify([]),{expires:7300})}if(typeof e!="undefined"){e=JSON.parse(e);var n=new app.services.AccountService;n.login(e.country,e.phone_number,e.password,function(t){app.fullPhoneNumber=t.data["phone_number"];app.userExitCode=t.data["exit_code"];app.phoneNumber=e.phone_number;app.country=e.country;app.password=e.password;$.mobile.changePage("#scheduled");$(".ui-page, .ui-mobile-viewport").addClass("ui-page-bg-light")},function(){$.removeCookie("logins");$.mobile.changePage("#login",{transition:"fade"})})}else{$.mobile.changePage("#login",{transition:"fade"})}}};app.pages.statusDialog={init:function(){$("#status-dialog").live("pagebeforeshow",function(){app.pages.statusDialog.onLoaded()})},onLoaded:function(){if(app.editViewStatus!="unsynced"){var e=new app.services.MessageService;e.getStatusDescription(function(e){$("#status-dialog-content").html(e)},function(){app.ajaxAlert("terms")})}else{$("#status-dialog-content").html("We can't sync this message with our system. Please connect to a mobile network or internet connection.")}}};app.pages.terms={init:function(){$("#terms").live("pagebeforeshow",function(){app.pages.terms.onLoaded()})},onLoaded:function(){if(app.lastPageBeforeTerms!="verification"){$("#terms").addClass("bg-light")}else{$("#terms").removeClass("bg-light")}var e=new app.services.TermsService;e.getTerms(function(e){$("#terms-content").html(e)})}};app.pages.verification={init:function(){$("#verification").live("pagebeforeshow",function(){app.pages.verification.onLoaded()});$("#verification-invalid-format").live("click",function(){var e=new app.services.AccountService;e.formatting(function(){$("#verification form").css("bottom",0);app.ajaxAlert("verification","Thanks - we'll look in to it right away.")})});$("#verification-submit-button").live("click",function(){var e=$("#verification-pin").val();var t="country="+app.country+"&phone_number="+app.phoneNumber+"&pin="+e;var n;if(app.verificationType=="forgotten"){n=$("#verification-password").val();t+="&password="+n}var r=new app.services.AccountService;r.verify(t,function(){if(app.verificationType=="forgotten"){app.ajaxAlert("verification","Thanks - your password has been reset.","login")}else{r.login(app.country,app.phoneNumber,app.password,function(e){app.fullPhoneNumber=e.data["phone_number"];app.userExitCode=e.data["exit_code"];$(".ui-page, .ui-mobile-viewport").addClass("ui-page-bg-light");$.mobile.changePage("#scheduled")},function(){app.ajaxAlert("verification")})}},function(){if(app.verificationType=="forgotten"){app.ajaxAlert("verification","We think there might be an error with the verification code or password that you've entered - please review.")}else{app.ajaxAlert("verification","We think there might be an error with the verification code that you've entered - please review.")}})})},onLoaded:function(){app.clearTimeouts();$("#verification-sent-number").text("+"+app.fullPhoneNumber);$("#verification").removeClass("verify-forgotten verify-register");$("#verification").addClass("verify-"+app.verificationType);if(app.verificationType=="forgotten"){$("#verification-nocode-text").hide();$("#verification-password_text").hide();$("#verification-password").show();$("#verification-firstline").text("You will shortly receive your verification code via text message. Simply enter the code in the box below along with your new password and hit verify.")}else{$("#verification-nocode-text").show();$("#verification-password").hide();$("#verification-password_text").show();$("#verification-firstline").text("You will shortly receive your verification code via text message. Simply enter the code in the box below and hit Verify.")}$("#verification-password").val("");$("#verification-pin").val("")}};app.services.AccountService=function(){};app.services.AccountService.prototype.login=function(e,t,n,r,i){var s=app.protocol+app.url+"/users/login";var o="country="+e+"&phone_number="+t+"&password="+n;app.ajaxPost(s,o,"login",function(e){r(e)},null,i)};app.services.AccountService.prototype.getCredits=function(e){var t=app.protocol+app.url+"/users/getCredits?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.AccountService.prototype.shownSpamFailNotification=function(e,t){var n=app.protocol+app.url+"/users/shownSpamFailNotification?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(n,e,t)};app.services.AccountService.prototype.register=function(e,t,n,r,i){var s=app.protocol+app.url+"/users/register";var o="country="+e+"&phone_number="+t+"&password="+n;app.ajaxPost(s,o,"register",r,null,i)};app.services.AccountService.prototype.formatting=function(e){var t=app.protocol+app.url+"/users/formatting";var n="country="+app.country+"&phone_number="+app.phoneNumber;app.ajaxPost(t,n,"verification",e)};app.services.AccountService.prototype.verify=function(e,t){var n=app.protocol+app.url+"/users/verify/"+app.verificationType;app.ajaxPost(n,e,"verification",t)};app.services.AccountService.prototype.forgotten=function(e,t,n,r){var i=app.protocol+app.url+"/users/forgotten";var s="country="+e+"&phone_number="+t;app.ajaxPost(i,s,"forgotten",n,null,r)};app.services.BillingService=function(){};app.services.BillingService.prototype.getProducts=function(e){var t=app.protocol+app.url+"/billing/listProducts?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.BillingService.prototype.verify=function(e,t,n,r){var i=app.protocol+app.url+"/billing/verify?u="+app.fullPhoneNumber+"&p="+app.password;var s={productId:t,transactionReceipt:n,transactionIdentifier:e};var o="Error occurred while processing the purchase. If you are sure you have made the purchase, please contact us.";app.ajaxPost(i,s,"purchase",r,o,function(){app.ajaxAlert("purchase",o)},function(e){var t=app.system.serialize(e,"error");app.ajaxAlert("purchase","Network error: "+t+". If you are sure you have made the purchase, please contact us.")})};app.services.ContactService=function(){};app.services.ContactService.prototype.getAllContacts=function(e){var t=this;var n={filter:"",multiple:true};var r=["*"];navigator.contacts.find(r,function(n){try{t._sort(n);var r=t._parseContactItems(n);e(r)}catch(i){app.alert("init contacts error: "+i,"Error")}},function(){app.ajaxAlert("login","Your phone book seems unavaiable at present please trying reaccessing.")},n)};app.services.ContactService.prototype._sort=function(e){e.sort(function(e,t){if(e.name==undefined||t.name==undefined){return 1}var n=null!==e.name.familyName?e.name.familyName:e.name.formatted,r=null!==t.name.familyName?t.name.familyName:t.name.formatted;if(n!=r){n=e.name.formatted;r=t.name.formatted}return n>r?1:-1});return e};app.services.ContactService.prototype._parseContactItems=function(e){var t=this;var n=[];for(var r=0;r<e.length;r++){var i=e[r];if(i.phoneNumbers==undefined||i.phoneNumbers.length==0){continue}for(var s=0;s<i.phoneNumbers.length;s++){var o=i.phoneNumbers[s].value;if(typeof o=="undefined"||o==null||o==""){continue}var u=t._getContactName(i);n.push(t._createContactItem(u,o))}}return n};app.services.ContactService.prototype._getContactName=function(e){if(e.name&&e.name.formatted){return e.name.formatted}if(e.displayName!=undefined){return e.displayName}return""};app.services.ContactService.prototype._createContactItem=function(e,t){return{id:t,name:e,number:t,isCustom:function(){return this.name==undefined||this.name==null||this.name==""}}};app.services.CountryService=function(){};app.services.CountryService.prototype.load=function(){var e=app.protocol+app.url+"/users/countries";app.ajaxGet(e,function(e){$("#forgotten-country option, #login-country option, #register-country option").remove();var t=0;$.each(e.data,function(n){var r="";if(devSettings.isDebug){if(n=="GB"){r=' selected="selected"'}}else if(t++<1){r=' selected="selected"'}$("#forgotten-country, #login-country, #register-country").append('<option value="'+n+'"'+r+">"+e.data[n]+"</option>")});try{$("#forgotten-country, #login-country, #register-country").selectmenu().selectmenu("refresh");$("#login-country").trigger("change")}catch(n){app.alert(n,"Error",function(){$("#login-country").trigger("change")})}})};app.services.CreditService=function(){};app.services.CreditService.prototype.getInternationalCredits=function(e){var t=app.protocol+app.url+"/users/getInternationalCredits?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.GroupService=function(){};app.services.GroupService.prototype.getAll=function(e){var t=app.protocol+app.url+"/groups/index?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.GroupService.prototype.delete=function(e,t){var n=app.protocol+app.url+"/groups/delete/"+e+"?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(n,t)};app.services.GroupService.prototype.getGroup=function(e,t){var n=app.protocol+app.url+"/groups/view/"+e+"?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(n,function(e){t(e.data)})};app.services.GroupService.prototype.editGroup=function(e){var t=app.protocol+app.url+"/groups/edit/"+e+"?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxPost(t,{},"newgroup")};app.services.GroupService.prototype.validate=function(e,t,n,r,i,s){var o=app.protocol+app.url+"/groups/validates?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxPost(o,e,t,r,n,function(){if(n!=null&&n!=""){app.ajaxAlert(t,n)}if(i!=undefined){i()}},s)};app.services.GroupService.prototype.addEdit=function(e,t,n,r){var i=app.protocol+app.url+"/groups/"+(!e?"add":"edit/"+$("#newgroup .edit-id").val())+"?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxPost(i,t,"newgroup",n,null,r)};app.services.MessageService=function(){};app.services.MessageService.prototype.getScheduled=function(e){var t=app.protocol+app.url+"/sms/index/scheduled?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.MessageService.prototype.getSent=function(e){var t=app.protocol+app.url+"/sms/index/sent?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(t,function(t){e(t.data)})};app.services.MessageService.prototype.getStatusDescription=function(e,t){var n=app.protocol+app.url+"/sms/getStatusDescription/"+app.editViewStatus+"?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxGet(n,function(t){e(t.data)},t)};app.services.MessageService.prototype.validate=function(e,t,n,r,i){var s=app.protocol+app.url+"/sms/validates?u="+app.fullPhoneNumber+"&p="+app.password;app.ajaxPost(s,t,e,n,null,r,i)};app.services.MessageService.prototype.editOrSchedule=function(e,t,n,r){var i=app.protocol+app.url+"/sms/"+(app.editing&&app.editType!="single"?"edit/"+e:"schedule")+"?u="+app.fullPhoneNumber+"&p="+app.password;$.ajax({url:i,type:"POST",data:t,beforeSend:function(){app.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){r()},success:function(e){$("#"+$.mobile.activePage.attr("id")+" .progressbar-status").text("Saved!");e=JSON.parse(e);if(e.status=="OK"){n(e)}else{var t=e.data[0][0];app.ajaxAlert($.mobile.activePage.attr("id"),t)}},error:function(){app.saveAsUnsynced();$.mobile.changePage("#scheduled")}})};app.services.TermsService=function(){};app.services.TermsService.prototype.getTerms=function(e){var t=app.protocol+app.url+"/pages/terms";app.ajaxGet(t,function(t){e(t.data)})};app.ajaxPost=function(e,t,n,r,i,s,o,u){if(typeof n=="undefined"||n==null){n=$.mobile.activePage.attr("id")}$.ajax({url:e,type:"POST",data:t,beforeSend:function(){app.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){if(u==undefined||u==null){app.clearTimeouts();$.mobile.loading("hide")}else{u()}},success:function(e){e=JSON.parse(e);if(e.status=="OK"){if(r!=undefined&&r!=null){r(e)}}else{if(s!=undefined){s()}else{app.ajaxAlert(n,i)}}},error:function(e){if(o!=undefined){o(e)}else{app.ajaxAlert(n)}}})};app.ajaxGet=function(e,t,n){$.ajax({url:e,type:"GET",beforeSend:function(){app.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){app.clearTimeouts();$.mobile.loading("hide")},success:function(e){e=JSON.parse(e);if(e.status=="OK"){t(e)}else{if(n==undefined||n==null){app.ajaxAlert($.mobile.activePage.attr("id"))}else{n()}}},error:function(){if(n==undefined||n==null){app.ajaxAlert($.mobile.activePage.attr("id"))}else{n()}}})};app.ajaxAlert=function(e,t,n){var r=this;var i=$("#"+e+" .error");if(typeof t=="undefined"||t==null||t==""){t="Something went wrong, please try again."}i.find(".inner").html(t);if(typeof n!="undefined"){r.ajaxAlertCallback=n}$("body").append('<div class="error-overlay"><div>');i.slideDown();$(".error, .error-overlay").bind("click tap",function(){if(r.showingSpamFailNotification){r.showingSpamFailNotification=false;var e=new app.services.AccountService;e.shownSpamFailNotification(function(){$(".error, .error-overlay").slideUp().unbind("click tap");if(r.ajaxAlertCallback!=null){n=r.ajaxAlertCallback;r.ajaxAlertCallback=null;$.mobile.changePage("#"+n)}},function(){r.ajaxAlert($.mobile.activePage.attr("id"))})}else{$(".error, .error-overlay").slideUp();$(this).unbind("click tap");if(r.ajaxAlertCallback!=null){n=r.ajaxAlertCallback;r.ajaxAlertCallback=null;$.mobile.changePage("#"+n)}}})};app.doBinds=function(){var e=this;if(devSettings.isDebug){$("#login-phone_number").val("07960270356");$("#login-password").val("autotext")}$("a.external-link").live("click",function(e){e.preventDefault();window.open($(e.currentTarget).attr("href"),"_system")});$(".schedule-link, .history-link, .groups-link").live("click",function(){var e=false;var t="";switch($.mobile.activePage.attr("id")){case"scheduled":if($(this).hasClass("history-link")){t="history"}else if($(this).hasClass("groups-link")){t="groups"}break;case"history":if($(this).hasClass("schedule-link")){e=true;t="scheduled"}else if($(this).hasClass("groups-link")){t="groups"}break;case"groups":e=true;if($(this).hasClass("schedule-link")){t="scheduled"}else if($(this).hasClass("history-link")){t="history"}break}if(t.length>0)$.mobile.changePage("#"+t,{reverse:e})});$("input").live("keyup",function(e){var t=e.charCode?e.charCode:e.keyCode?e.keyCode:0;if(t==13){e.preventDefault();var n=$.mobile.activePage.attr("id");switch(n){case"login":$("#login-submit-button").trigger("click");break;case"register":$("#register-submit-button").trigger("click");break;case"forgotten":$("#forgotten-submit-button").trigger("click");break;case"verification":$("#verification-submit-button").trigger("click");break;case"new":var r=$("#new .save:visible");if(r.length<1)r=$("#new-submit-button");r.trigger("click");break;case"message-name":$("#message-name .back").trigger("click");break;case"newgroup":$("#newgroup .save").trigger("click");break;case"addcontactfromnumber":$("#addcontactfromnumber .save").trigger("click");break;case"addNumber":$("#addNumber .back").trigger("click");break}}});$("textarea").off("keyup").autoGrowTextArea();$(".new-link").live("click",function(){$("#new-content").height(28)});$(".reminder-link").live("click",function(){$("#new-content").height(28)});$(".terms").live("click",function(){e.lastPageBeforeTerms=$.mobile.activePage.attr("id");$.mobile.changePage("#terms")});$("#login-country, #forgotten-country").live("change",function(){if(!e.stopCountryChange){$.ajax({url:e.protocol+e.url+"/users/getExitCode/"+$(this).find("option:selected").val(),type:"GET",beforeSend:function(){e.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){e.clearTimeouts();$.mobile.loading("hide")},success:function(t){t=JSON.parse(t);if(t.status=="OK"){e.userExitCode=t.data}else{e.ajaxAlert($.mobile.activePage.attr("id"))}},error:function(){e.ajaxAlert($.mobile.activePage.attr("id"))}})}});$(".messagecredits-button").live("click",function(){e.lastPageBeforeMessageCredits=$.mobile.activePage.attr("id");$.mobile.changePage("#messagecredits")});$("#new-name, #new-content").live("keyup",function(){if(!e.reminding){var t=$("#new-name").val();if(t.length>0)t+=" - ";t+=$("#new-content").val();if(t.length<1&&!e.editing){t="New Message"}else if(t.length<1){t="Edit Message"}$("#new .page-title").text(t)}});$(".edit-repeats .single").live("click",function(){e.editType="single";$(".dialog-overlay, .edit-repeats").hide();app.pages.newMessage.newActualSave()});$(".edit-repeats .all").live("click",function(){e.editType="all";$(".dialog-overlay, .edit-repeats").hide();app.pages.newMessage.newActualSave()});$(".edit-repeats .cancel").live("click",function(){$(".dialog-overlay, .edit-repeats").hide()});$(".new-link").live("click",function(t){t.preventDefault();e.reminding=false;e.editData={};e.newPageResetFields();e.lastPageBeforeNew=$.mobile.activePage.attr("id");e.newDraft=true;$.mobile.changePage("#new",{transition:"slide"})});$(".reminder-link").live("click",function(t){t.preventDefault();e.reminding=true;e.newPageResetFields();e.lastPageBeforeNew=$.mobile.activePage.attr("id");$.mobile.changePage("#new",{transition:"slide"})});$("#new .back, #register .back, #forgotten .back, #verification .back, #terms .back, #status-dialog .back, #purchase .back, #settings .back, #account .back, #help .back, #help-1 .back, #help-2 .back, #help-3 .back, #help-4 .back, #help-5 .back, #help-6 .back, #help-7 .back, #messagecredits .back, #newgroup .back, #addcontactfromnumber .back").live("click",function(){var t=$.mobile.activePage.attr("id");var n="";var r=$.mobile.defaultPageTransition;switch(t){case"new":n=e.lastPageBeforeNew;r="slideup";break;case"register":n="login";break;case"forgotten":n="login";break;case"verification":n=e.verificationType;break;case"terms":n=e.lastPageBeforeTerms;break;case"status-dialog":n="new";break;case"purchase":n=e.lastPageBeforePurchase;break;case"settings":n=e.lastPageBeforeSettings;break;case"account":n="settings";break;case"help":n="settings";break;case"help-1":n="help";break;case"help-2":n="help-1";break;case"help-3":n="help-2";break;case"help-4":n="help-3";break;case"help-5":n="help-4";break;case"help-6":n="help-5";break;case"help-7":n="help-6";break;case"messagecredits":n=e.lastPageBeforeMessageCredits;break;case"newgroup":n="groups";break;case"addcontactfromnumber":n="newgroup";break;default:e.ajaxAlert(t);break}if(n.length>0){$.mobile.changePage("#"+n,{reverse:true,transition:r})}})};app.refreshList=function(e){var t=this;setTimeout(function(){if($.mobile.activePage.attr("id")==e){t.pages[e].onLoaded();t.refreshList(e)}},6e4)};app.newPageResetFields=function(){var e=this;if(e.canResetNewPage){e.newData={name:"",recipient:"",content:"",time:"",reminder:"",repeat_options:""};$("#new-name, #new-recipient, #new-content").val("");$('#message-repeats input[name="message-repeats"]').removeAttr("checked");$("#message-repeats-none").attr("checked","checked");try{$('#message-repeats input[name="message-repeats"]').checkboxradio("refresh")}catch(t){}$("#message-repeats-wd option:selected").removeAttr("selected");$('#message-repeats-wd option[value="off"]').attr("selected","selected");try{$("#message-repeats-wd").slider("refresh")}catch(t){}var n=$("#new-date");n.val("").scroller("destroy").removeClass("scrollified");if(!e.viewing){n.scroller({preset:"calendar",theme:"ios",mode:"scroller",display:"inline",lang:"en"}).addClass("scrollified")}$("#new-date-text").text("")}};app.saveAsUnsynced=function(){var e=this;e.unsyncEdit=true;e.updateDrafts("edit",e.draftId,null,true);e.justSetUnsynced=true;if(e.unsyncedTimer===null){e.unsyncedTimer=setTimeout(function(){e.processUnsynced()},6e4)}};app.processUnsynced=function(){var e=this;var t=e.updateDrafts("unsynced");if(t.length>0){var n=t[0];var r={name:n.Sms["name"],recipient:n.Sms["recipient"],content:n.Sms["content"],time:n.Schedule["send_time"],repeat_options:n.Sms["repeat_options"],reminder:n.Sms["reminder"]};var i=Math.floor((new Date).getTime()/1e3)+60;if(r.time<i)r.time=i;var s=n.Sms["real_id"]!=undefined&&n.Sms["real_id"].length>0;var o=[];if(s)o=n.Sms["real_id"].split("&");$.ajax({url:e.protocol+e.url+"/sms/"+(s?"edit/"+o[0]:"schedule")+"?u="+e.fullPhoneNumber+"&p="+e.password,type:"POST",data:$.param(r),beforeSend:function(){clearTimeout(e.unsyncedTimer);e.loadingTimers.push(setTimeout(function(){$.mobile.loading("show")},1e3))},complete:function(){e.clearTimeouts();$.mobile.loading("hide")},success:function(r){r=JSON.parse(r);if(r.status=="OK"){e.updateDrafts("delete",n.Sms["id"]);if(t.length>1){e.processUnsynced()}else{clearTimeout(e.unsyncedTimer);e.unsyncedTimer=null;app.pages.scheduled.onLoaded();e.refreshList("scheduled")}}else{e.unsyncedTimer=setTimeout(function(){e.processUnsynced()},6e4)}},error:function(){e.unsyncedTimer=setTimeout(function(){e.processUnsynced()},6e4)}})}else{clearTimeout(e.unsyncedTimer);e.unsyncedTimer=null}};app.updateDrafts=function(e,t,n,r,i){var s=this;if(typeof e!="string")return false;var o=JSON.parse($.cookie("drafts"));switch(e){default:return false;case"add":if(typeof n!="object")return false;s.draftEdit=true;o.push(n);break;case"edit":if(typeof t!="string")return false;s.draftEdit=true;$(o).each(function(e){if(o[e].Sms["id"]==t){var n=$('input[name="message-repeats"]:checked').val().toUpperCase();var i=$("#message-repeats-wd option:selected").val()=="on";var u={D:0,W:0,M:0,Y:0,WD:0};if(typeof u[n]!="undefined")u[n]=1;if(i)u["WD"]=1;var a=null;var f=r!=undefined?r:o[e].Sms["unsynced"];if(o[e].Sms["real_id"]!=undefined)a=o[e].Sms["real_id"];o[e]={Sms:{content:$("#new-content").val(),id:t,is_draft:true,name:$("#new-name").val(),recipient:$("#new-recipient").val(),recipient_user:$("#new-recipient").val(),reminder:s.reminding?"1":"0",repeat_options:JSON.stringify(u),unsynced:f},Schedule:{id:s.generateUUID(),send_time:$("#new-date").val().length>0?(new Date($("#new-date").val())).getTime()/1e3:(new Date).getTime()/1e3,status:f?"unsynced":"draft",status_colour:f?"f0b05f":"a3a3a3",status_text:f?"Unsynced":"Draft"}};if(a!=null)o[e].Sms["real_id"]=a}});break;case"view":if(typeof t!="string")return false;var u=null;s.draftId=t;$(o).each(function(e){if(o[e].Sms["id"]==t){u=o[e]}});if(u===null){var a=r!=undefined?r:false;u={Sms:{content:s.editData.content,id:t,is_draft:true,name:s.editData.name,recipient:s.editData.recipient,recipient_user:s.editData.recipient_user,reminder:s.reminding?"1":"0",repeat_options:s.editData.repeat_options,unsynced:a},Schedule:{id:s.generateUUID(),send_time:s.editData.schedule_time,status:a?"unsynced":"draft",status_colour:"a3a3a3",status_text:a?"Unsynced":"Draft"}};if(i){s.updateDrafts("add",0,u)}else{var f=$("#new .edit-id").val();if(f.length>0){u.Sms["real_id"]=f}else if($("#new #new-recipient").val()!=""||$("#new #new-content").val()!=""||i){s.updateDrafts("add",0,u)}}}return u;case"delete":if(typeof t!="string")return false;var l=[];$(o).each(function(e){if(o[e].Sms["id"]!=t){l.push(o[e])}});o=l;break;case"wipe":o=[];break;case"list":var c=JSON.parse($.cookie("drafts"));var h=[];var p=[];$.each(c,function(e){h.push(c[e].Schedule.send_time)});h=s.asort(h);for(var d=0;d<h.length;d++){for(var v=0;v<c.length;v++){if(h[d]==c[v].Schedule.send_time){p.push(c[v])}}}return p;case"unsynced":var m=JSON.parse($.cookie("drafts"));var g=[];$.each(m,function(e){if(m[e].Sms["unsynced"]){g.push(m[e])}});return g}$.cookie("drafts",JSON.stringify(o),{expires:7300});return true};app.asort=function(e){return e.sort(function(e,t){return e-t})};app.generateUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})};app.doProgressBar=function(){try{if($("#"+$.mobile.activePage.attr("id")+" .progressbar:visible").length<1){$("#"+$.mobile.activePage.attr("id")+" h1 .page-title").hide();$("#"+$.mobile.activePage.attr("id")+" .progressbar").show();$("#"+$.mobile.activePage.attr("id")+" .progressbar-status").css("display","block");$("#new h1").css("overflow","visible");TolitoProgressBar("#"+$.mobile.activePage.attr("id")+" .progressbar").isMini(true).showCounter(false).setInterval(20).setMax(125).setOuterTheme("b").setInnerTheme("c").build().init()}}catch(e){console.log("progressbar error: "+e)}};app.formatNumbersWithContactNames=function(e,t,n){if(typeof n=="undefined")n=false;e=e==undefined?[]:e.split(",");var r="";for(var i=0;i<e.length;i++){r+="<span"+(n?' data-role="button" data-mini="true"':"")+' data-phone_number="'+e[i]+'">';r+=e[i];if(!n&&i+1<e.length)r+=", "}t.html(r)};app.formatDate=function(e){var t=""+parseInt(e.getDate());var n=""+parseInt(e.getMonth()+1);var r=""+parseInt(e.getFullYear());t=t>9?t:"0"+t;n=n>9?n:"0"+n;return t+"/"+n+"/"+r};app.formatTime=function(e,t){if(typeof t=="undefined")t=false;var n=""+e.getHours();var r=""+e.getMinutes();n=n>9?n:"0"+n;r=r>9?r:"0"+r;return n+":"+r};app.clearTimeouts=function(){var e=this;$.each(e.loadingTimers,function(t){clearTimeout(e.loadingTimers[t])})};window.devSettings={isDebug:false};window.logger={actions:[],log:function(e){this.actions.push(e);if(this.actions.length<=1){this._log()}},_log:function(){var e=this;if(this.actions.length>0){var t=this.actions[0];$("#log").html(t);this.actions.splice(0,1)}if(this.actions.length>0){setTimeout(function(){e._log()},5e3)}}};app.system={serialize:function(e,t){var n="";try{function r(e,t){for(p in e){var i=e[p];if(typeof i=="object"){if(p*1>=0){r(i,t+"["+p+"]")}else{r(i,t+"."+p)}}else if(typeof i!="function"){n+="\n"+t+"."+p+" = "+i}}}r(e,t)}catch(i){}return n},isInArray:function(e,t){for(var n=0;n<t.length;n++){if(t[n]==e){return true}}return false},toast:function(e,t){var n={message:e,showDuration:500,displayDuration:2e3,hideDuration:500,css:t==undefined?"":t};var r=$("<div class='toast'>"+n.message+"</div>");if(n.css!=""){r.addClass(n.css)}r.appendTo("body");var i=$(window).width()/2;var s=i-r.width()/2;var o=$(window).height()/10;r.css("bottom",0+"px");r.css("left",s+"px");r.animate({bottom:"+="+o,opacity:1},{duration:n.showDuration,complete:function(){setTimeout(function(){r.animate({opacity:0},{duration:n.hideDuration,complete:function(){r.remove()}})},n.displayDuration)}})},toastError:function(e){this.toast(e,"error")},fixPhoneNumber:function(e){if(e.substr(0,1)=="+"){e=app.userExitCode+e.substr(1)}e=e.replace(/[^0-9]/g,"");return e},getFirstOrDefault:function(e,t){if(e==null||e.length==0){return null}for(var n=0;n<e.length;n++){if(t(e[n])){return e[n]}}return null}}